########## packages/vent_zone_controller.yaml ##########
homeassistant: {}

# ───────────────────────────
# HELPERS (sliders + toggles)
# ───────────────────────────
input_number:
  min_other_room_open_pct:
    name: Min Other-Room Vent Open (%)
    min: 0
    max: 50
    step: 5
    icon: mdi:weather-windy
    initial: 25

  occupancy_linger_min:
    name: Occupancy Linger (min)
    min: 0
    max: 120
    step: 5
    icon: mdi:timer-sand
    initial: 30
  occupancy_linger_night_min:
    name: Occupancy Linger at Night (min)
    min: 0
    max: 240
    step: 5
    icon: mdi:weather-night
    initial: 90

  room_hysteresis_f:
    name: Room Hysteresis (°F)
    min: 0.5
    max: 3.0
    step: 0.1
    icon: mdi:tune
    initial: 1.0

  closed_threshold_pct:
    name: Closed Threshold (%)
    min: 0
    max: 40
    step: 5
    icon: mdi:percent
    initial: 10

  relief_open_pct:
    name: Relief Open (%)
    min: 40
    max: 100
    step: 5
    icon: mdi:fan
    initial: 60

  heat_boost_f:
    name: Heat Boost (°F)
    min: 0
    max: 3
    step: 0.5
    icon: mdi:thermometer-plus
    initial: 1.0

input_boolean:
  require_occupancy:
    name: Condition Only When Occupied
    icon: mdi:account-eye
    initial: true
  heat_boost_enabled:
    name: Heat Boost Enabled
    icon: mdi:fire
    initial: true

# ───────────────────────────
# GROUPS – confirm entity IDs match yours
# ───────────────────────────
group:
  vents_master_bedroom:
    name: Master Bedroom Vents
    entities:
      - cover.master_bedroom_v1
      - cover.master_bedroom_v2
  vents_blue_room:
    name: Blue Room Vents
    entities:
      - cover.blue_v1
      - cover.blue_v2
  vents_gold_room:
    name: Gold Room Vents
    entities:
      - cover.gold_v1
      - cover.gold_v2
  vents_green_room:
    name: Green Room Vents
    entities:
      - cover.green_v1
      - cover.green_v2
  vents_grey_room:
    name: Grey Room Vents
    entities:
      - cover.grey_v1
      - cover.grey_v2
  vents_guest_room:
    name: Guest Room Vents
    entities:
      - cover.guest_room_v1
      - cover.guest_room_v2
  vents_family_room:
    name: Family Room Vents
    entities:
      - cover.family_room_v1
      - cover.family_room_v2
  vents_kitchen:
    name: Kitchen Vents
    entities:
      - cover.kitchen_v1
      - cover.kitchen_v2
  vents_piano_room:
    name: Piano Room Vents
    entities:
      - cover.piano_room_v1  # add v2 if present
  vents_basement:
    name: Basement Vents
    entities:
      - cover.basement_v1
      - cover.basement_v2
      - cover.basement_v3

  vent_groups_all:
    name: All Flair Vents
    entities:
      - group.vents_master_bedroom
      - group.vents_blue_room
      - group.vents_gold_room
      - group.vents_green_room
      - group.vents_grey_room
      - group.vents_guest_room
      - group.vents_family_room
      - group.vents_kitchen
      - group.vents_piano_room
      - group.vents_basement

# ───────────────────────────
# TEMPLATE SENSORS
#  - occupancy w/ night linger (22:00–06:00)
#  - per-room targets from climate.*
#  - per-room temps (sensor.* preferred; fallback climate current_temperature)
#  - per-room DELTAs = target − temp
#  - Rooms To Condition (multi-room) using delta + hysteresis
# ───────────────────────────
template:
  - binary_sensor:
      - name: "Master Occupied Recent"
        state: >
          {% set base = states('input_number.occupancy_linger_min')|int(30) %}
          {% set night = states('input_number.occupancy_linger_night_min')|int(90) %}
          {% set linger = (night if (now().hour >= 22 or now().hour < 6) else base) * 60 %}
          {% set ent = 'binary_sensor.master_bedroom_occupancy' %}
          {{ is_state(ent,'on') or (as_timestamp(now()) - as_timestamp(states[ent].last_changed)) < linger }}
      - name: "Blue Occupied Recent"
        state: >
          {% set base = states('input_number.occupancy_linger_min')|int(30) %}
          {% set night = states('input_number.occupancy_linger_night_min')|int(90) %}
          {% set linger = (night if (now().hour >= 22 or now().hour < 6) else base) * 60 %}
          {% set ent = 'binary_sensor.blue_room_occupancy' %}
          {{ is_state(ent,'on') or (as_timestamp(now()) - as_timestamp(states[ent].last_changed)) < linger }}
      - name: "Gold Occupied Recent"
        state: >
          {% set base = states('input_number.occupancy_linger_min')|int(30) %}
          {% set night = states('input_number.occupancy_linger_night_min')|int(90) %}
          {% set linger = (night if (now().hour >= 22 or now().hour < 6) else base) * 60 %}
          {% set ent = 'binary_sensor.gold_room_occupancy' %}
          {{ is_state(ent,'on') or (as_timestamp(now()) - as_timestamp(states[ent].last_changed)) < linger }}
      - name: "Green Occupied Recent"
        state: >
          {% set base = states('input_number.occupancy_linger_min')|int(30) %}
          {% set night = states('input_number.occupancy_linger_night_min')|int(90) %}
          {% set linger = (night if (now().hour >= 22 or now().hour < 6) else base) * 60 %}
          {% set ent = 'binary_sensor.green_room_occupancy' %}
          {{ is_state(ent,'on') or (as_timestamp(now()) - as_timestamp(states[ent].last_changed)) < linger }}
      - name: "Grey Occupied Recent"
        state: >
          {% set base = states('input_number.occupancy_linger_min')|int(30) %}
          {% set night = states('input_number.occupancy_linger_night_min')|int(90) %}
          {% set linger = (night if (now().hour >= 22 or now().hour < 6) else base) * 60 %}
          {% set ent = 'binary_sensor.grey_room_occupancy' %}
          {{ is_state(ent,'on') or (as_timestamp(now()) - as_timestamp(states[ent].last_changed)) < linger }}
      - name: "Basement Occupied Recent"
        state: >
          {% set base = states('input_number.occupancy_linger_min')|int(30) %}
          {% set night = states('input_number.occupancy_linger_night_min')|int(90) %}
          {% set linger = (night if (now().hour >= 22 or now().hour < 6) else base) * 60 %}
          {% set ent = 'binary_sensor.basement_occupancy' %}
          {{ is_state(ent,'on') or (as_timestamp(now()) - as_timestamp(states[ent].last_changed)) < linger }}
      - name: "Kitchen Occupied Recent"
        state: >
          {% set base = states('input_number.occupancy_linger_min')|int(30) %}
          {% set night = states('input_number.occupancy_linger_night_min')|int(90) %}
          {% set linger = (night if (now().hour >= 22 or now().hour < 6) else base) * 60 %}
          {% set ent = 'binary_sensor.kitchen_occupancy' %}
          {{ is_state(ent,'on') or (as_timestamp(now()) - as_timestamp(states[ent].last_changed)) < linger }}
      - name: "Family Room Occupied Recent"
        state: >
          {% set base = states('input_number.occupancy_linger_min')|int(30) %}
          {% set night = states('input_number.occupancy_linger_night_min')|int(90) %}
          {% set linger = (night if (now().hour >= 22 or now().hour < 6) else base) * 60 %}
          {% set ent = 'binary_sensor.family_room_occupancy' %}
          {{ is_state(ent,'on') or (as_timestamp(now()) - as_timestamp(states[ent].last_changed)) < linger }}
      - name: "Guest Room Occupied Recent"
        state: >
          {% set base = states('input_number.occupancy_linger_min')|int(30) %}
          {% set night = states('input_number.occupancy_linger_night_min')|int(90) %}
          {% set linger = (night if (now().hour >= 22 or now().hour < 6) else base) * 60 %}
          {% set ent = 'binary_sensor.guest_room_occupancy' %}
          {{ is_state(ent,'on') or (as_timestamp(now()) - as_timestamp(states[ent].last_changed)) < linger }}

  - sensor:
      # ---- Per-room TARGETS pulled from climate.* ----
      - name: "Master Target (°F)"
        unit_of_measurement: "°F"
        state: >
          {% set c = 'climate.master_bedroom_room' %}
          {% set t = state_attr(c,'temperature') %}
          {% if t is not none %} {{ t|float }}
          {% else %}
            {% set lo = state_attr(c,'target_temp_low') %}
            {% set hi = state_attr(c,'target_temp_high') %}
            {{ (((lo|float) + (hi|float)) / 2) if (lo is not none and hi is not none) else 72 }}
          {% endif %}
      - name: "Blue Target (°F)"
        unit_of_measurement: "°F"
        state: >
          {% set c = 'climate.bella_room' %}
          {% set t = state_attr(c,'temperature') %}
          {% if t is not none %} {{ t|float }}
          {% else %}
            {% set lo = state_attr(c,'target_temp_low') %}
            {% set hi = state_attr(c,'target_temp_high') %}
            {{ (((lo|float) + (hi|float)) / 2) if (lo is not none and hi is not none) else 72 }}
          {% endif %}
      - name: "Gold Target (°F)"
        unit_of_measurement: "°F"
        state: >
          {% set c = 'climate.julia_room' %}
          {% set t = state_attr(c,'temperature') %}
          {% if t is not none %} {{ t|float }}
          {% else %}
            {% set lo = state_attr(c,'target_temp_low') %}
            {% set hi = state_attr(c,'target_temp_high') %}
            {{ (((lo|float) + (hi|float)) / 2) if (lo is not none and hi is not none) else 72 }}
          {% endif %}
      - name: "Green Target (°F)"
        unit_of_measurement: "°F"
        state: >
          {% set c = 'climate.gabriel_room' %}
          {% set t = state_attr(c,'temperature') %}
          {% if t is not none %} {{ t|float }}
          {% else %}
            {% set lo = state_attr(c,'target_temp_low') %}
            {% set hi = state_attr(c,'target_temp_high') %}
            {{ (((lo|float) + (hi|float)) / 2) if (lo is not none and hi is not none) else 72 }}
          {% endif %}
      - name: "Grey Target (°F)"
        unit_of_measurement: "°F"
        state: >
          {% set c = 'climate.bunk_room_room' %}
          {% set t = state_attr(c,'temperature') %}
          {% if t is not none %} {{ t|float }}
          {% else %}
            {% set lo = state_attr(c,'target_temp_low') %}
            {% set hi = state_attr(c,'target_temp_high') %}
            {{ (((lo|float) + (hi|float)) / 2) if (lo is not none and hi is not none) else 72 }}
          {% endif %}
      - name: "Guest Target (°F)"
        unit_of_measurement: "°F"
        state: >
          {% set c = 'climate.guest_room_room' %}
          {% set t = state_attr(c,'temperature') %}
          {% if t is not none %} {{ t|float }}
          {% else %}
            {% set lo = state_attr(c,'target_temp_low') %}
            {% set hi = state_attr(c,'target_temp_high') %}
            {{ (((lo|float) + (hi|float)) / 2) if (lo is not none and hi is not none) else 72 }}
          {% endif %}
      - name: "Family Target (°F)"
        unit_of_measurement: "°F"
        state: >
          {% set c = 'climate.family_room_room' %}
          {% set t = state_attr(c,'temperature') %}
          {% if t is not none %} {{ t|float }}
          {% else %}
            {% set lo = state_attr(c,'target_temp_low') %}
            {% set hi = state_attr(c,'target_temp_high') %}
            {{ (((lo|float) + (hi|float)) / 2) if (lo is not none and hi is not none) else 72 }}
          {% endif %}
      - name: "Kitchen Target (°F)"
        unit_of_measurement: "°F"
        state: >
          {% set c = 'climate.kitchen_room_2' %}
          {% set t = state_attr(c,'temperature') %}
          {% if t is not none %} {{ t|float }}
          {% else %}
            {% set lo = state_attr(c,'target_temp_low') %}
            {% set hi = state_attr(c,'target_temp_high') %}
            {{ (((lo|float) + (hi|float)) / 2) if (lo is not none and hi is not none) else 72 }}
          {% endif %}
      - name: "Basement Target (°F)"
        unit_of_measurement: "°F"
        state: >
          {% set c = 'climate.basement_room' %}
          {% set t = state_attr(c,'temperature') %}
          {% if t is not none %} {{ t|float }}
          {% else %}
            {% set lo = state_attr(c,'target_temp_low') %}
            {% set hi = state_attr(c,'target_temp_high') %}
            {{ (((lo|float) + (hi|float)) / 2) if (lo is not none and hi is not none) else 72 }}
          {% endif %}

      # ---- Per-room TEMPS (sensor.* preferred; fallback to climate current_temperature) ----
      - name: "Master Temp (°F)"
        unit_of_measurement: "°F"
        state: >
          {% set s = states('sensor.master_bedroom_temperature') %}
          {{ (s|float) if s not in ['unknown','unavailable','None','none'] else (state_attr('climate.master_bedroom_room','current_temperature')|float(0)) }}
      - name: "Blue Temp (°F)"
        unit_of_measurement: "°F"
        state: >
          {% set s = states('sensor.blue_room_temperature') %}
          {{ (s|float) if s not in ['unknown','unavailable','None','none'] else (state_attr('climate.bella_room','current_temperature')|float(0)) }}
      - name: "Gold Temp (°F)"
        unit_of_measurement: "°F"
        state: >
          {% set s = states('sensor.gold_room_sensor_temperature') %}
          {{ (s|float) if s not in ['unknown','unavailable','None','none'] else (state_attr('climate.julia_room','current_temperature')|float(0)) }}
      - name: "Green Temp (°F)"
        unit_of_measurement: "°F"
        state: >
          {% set s = states('sensor.green_room_temperature') %}
          {{ (s|float) if s not in ['unknown','unavailable','None','none'] else (state_attr('climate.gabriel_room','current_temperature')|float(0)) }}
      - name: "Grey Temp (°F)"
        unit_of_measurement: "°F"
        state: >
          {% set s = states('sensor.grey_room_temperature') %}
          {{ (s|float) if s not in ['unknown','unavailable','None','none'] else (state_attr('climate.bunk_room_room','current_temperature')|float(0)) }}
      - name: "Guest Temp (°F)"
        unit_of_measurement: "°F"
        state: >
          {% set s = states('sensor.guest_room_temperature') %}
          {{ (s|float) if s not in ['unknown','unavailable','None','none'] else (state_attr('climate.guest_room_room','current_temperature')|float(0)) }}
      - name: "Family Temp (°F)"
        unit_of_measurement: "°F"
        state: >
          {% set s = states('sensor.family_room_temperature') %}
          {{ (s|float) if s not in ['unknown','unavailable','None','none'] else (state_attr('climate.family_room_room','current_temperature')|float(0)) }}
      - name: "Kitchen Temp (°F)"
        unit_of_measurement: "°F"
        state: >
          {% set s = states('sensor.kitchen_temperature') %}
          {{ (s|float) if s not in ['unknown','unavailable','None','none'] else (state_attr('climate.kitchen_room_2','current_temperature')|float(0)) }}
      - name: "Basement Temp (°F)"
        unit_of_measurement: "°F"
        state: >
          {% set s = states('sensor.basement_temperature') %}
          {{ (s|float) if s not in ['unknown','unavailable','None','none'] else (state_attr('climate.basement_room','current_temperature')|float(0)) }}

      # ---- DELTAS = target − temp (°F) ----
      - name: "Master Delta (°F)"
        unit_of_measurement: "°F"
        state: "{{ (states('sensor.master_target_f')|float(72) - states('sensor.master_temp_f')|float(0)) | round(1) }}"
      - name: "Blue Delta (°F)"
        unit_of_measurement: "°F"
        state: "{{ (states('sensor.blue_target_f')|float(72) - states('sensor.blue_temp_f')|float(0)) | round(1) }}"
      - name: "Gold Delta (°F)"
        unit_of_measurement: "°F"
        state: "{{ (states('sensor.gold_target_f')|float(72) - states('sensor.gold_temp_f')|float(0)) | round(1) }}"
      - name: "Green Delta (°F)"
        unit_of_measurement: "°F"
        state: "{{ (states('sensor.green_target_f')|float(72) - states('sensor.green_temp_f')|float(0)) | round(1) }}"
      - name: "Grey Delta (°F)"
        unit_of_measurement: "°F"
        state: "{{ (states('sensor.grey_target_f')|float(72) - states('sensor.grey_temp_f')|float(0)) | round(1) }}"
      - name: "Guest Delta (°F)"
        unit_of_measurement: "°F"
        state: "{{ (states('sensor.guest_target_f')|float(72) - states('sensor.guest_temp_f')|float(0)) | round(1) }}"
      - name: "Family Delta (°F)"
        unit_of_measurement: "°F"
        state: "{{ (states('sensor.family_target_f')|float(72) - states('sensor.family_temp_f')|float(0)) | round(1) }}"
      - name: "Kitchen Delta (°F)"
        unit_of_measurement: "°F"
        state: "{{ (states('sensor.kitchen_target_f')|float(72) - states('sensor.kitchen_temp_f')|float(0)) | round(1) }}"
      - name: "Basement Delta (°F)"
        unit_of_measurement: "°F"
        state: "{{ (states('sensor.basement_target_f')|float(72) - states('sensor.basement_temp_f')|float(0)) | round(1) }}"

      # ---- Multi-room selection using delta + hysteresis + occupancy ----
      - name: "Rooms To Condition"
        icon: mdi:home-thermometer-outline
        state: >
          {% set hys = states('input_number.room_hysteresis_f')|float(1) %}
          {% set mode = states('climate.main_floor_thermostat') %}
          {% set need_occ = is_state('input_boolean.require_occupancy','on') %}

          {% set rooms = [
            {'k':'master','d': states('sensor.master_delta_f')|float(0),'ok': is_state('binary_sensor.master_occupied_recent','on'),'group':'group.vents_master_bedroom'},
            {'k':'blue',  'd': states('sensor.blue_delta_f')  |float(0),'ok': is_state('binary_sensor.blue_occupied_recent','on'),  'group':'group.vents_blue_room'},
            {'k':'gold',  'd': states('sensor.gold_delta_f')  |float(0),'ok': is_state('binary_sensor.gold_occupied_recent','on'),  'group':'group.vents_gold_room'},
            {'k':'green', 'd': states('sensor.green_delta_f') |float(0),'ok': is_state('binary_sensor.green_occupied_recent','on'), 'group':'group.vents_green_room'},
            {'k':'grey',  'd': states('sensor.grey_delta_f')  |float(0),'ok': is_state('binary_sensor.grey_occupied_recent','on'),  'group':'group.vents_grey_room'},
            {'k':'guest', 'd': states('sensor.guest_delta_f') |float(0),'ok': is_state('binary_sensor.guest_room_occupied_recent','on'),'group':'group.vents_guest_room'},
            {'k':'family','d': states('sensor.family_delta_f')|float(0),'ok': is_state('binary_sensor.family_room_occupied_recent','on'),'group':'group.vents_family_room'},
            {'k':'kitchen','d':states('sensor.kitchen_delta_f')|float(0),'ok': is_state('binary_sensor.kitchen_occupied_recent','on'),'group':'group.vents_kitchen'},
            {'k':'basement','d':states('sensor.basement_delta_f')|float(0),'ok': is_state('binary_sensor.basement_occupied_recent','on'),'group':'group.vents_basement'}
          ] %}

          {% set ok_rooms = rooms if not need_occ else rooms | selectattr('ok') | list %}

          {# HEAT needs: positive delta > hys (too cold) #}
          {% set heat_rooms = (ok_rooms | selectattr('d','>',hys) | map(attribute='k') | list) if mode in ['heat','auto','heat_cool'] else [] %}
          {# COOL needs: negative delta < -hys (too hot) #}
          {% set cool_rooms = (ok_rooms | selectattr('d','<',-hys) | map(attribute='k') | list) if mode in ['cool','auto','heat_cool'] else [] %}

          {% if mode == 'heat' %} {{ heat_rooms|join(',') or 'none' }}
          {% elif mode == 'cool' %} {{ cool_rooms|join(',') or 'none' }}
          {% else %} {{ (heat_rooms + cool_rooms)|unique|join(',') or 'none' }}
          {% endif %}

# ───────────────────────────
# SCRIPTS
#   - set_multi_room_vents: opens selected rooms, applies ≤1/3-closed w/ temp+occ-aware relief
#   - apply_ecobee_hold_for_rooms: optional heat-boost; never changes hvac_mode
# ───────────────────────────
script:
  set_multi_room_vents:
    alias: "Set vents for multiple rooms (≤1/3 closed, delta/occ-aware relief)"
    mode: queued
    fields:
      rooms_csv:
        description: "Comma-separated room keys to fully open (e.g., 'master,blue')"
    sequence:
      - variables:
          min_other: "{{ states('input_number.min_other_room_open_pct') | int }}"
          close_thr: "{{ states('input_number.closed_threshold_pct') | int(10) }}"
          relief_pct: "{{ states('input_number.relief_open_pct') | int(60) }}"
          mode: "{{ states('climate.main_floor_thermostat') }}"
          action: "{{ state_attr('climate.main_floor_thermostat','hvac_action') | default('idle') }}"
          selected_list: >
            {% set s = (rooms_csv | default('') | trim | replace(' ','')) %}
            {{ s.split(',') if s not in ['','none'] else [] }}

          rooms: >
            {{ [
              {'k':'master','d': states('sensor.master_delta_f')|float(0),'occ': is_state('binary_sensor.master_occupied_recent','on'),'group':'group.vents_master_bedroom'},
              {'k':'blue','d': states('sensor.blue_delta_f')|float(0),'occ': is_state('binary_sensor.blue_occupied_recent','on'),'group':'group.vents_blue_room'},
              {'k':'gold','d': states('sensor.gold_delta_f')|float(0),'occ': is_state('binary_sensor.gold_occupied_recent','on'),'group':'group.vents_gold_room'},
              {'k':'green','d': states('sensor.green_delta_f')|float(0),'occ': is_state('binary_sensor.green_occupied_recent','on'),'group':'group.vents_green_room'},
              {'k':'grey','d': states('sensor.grey_delta_f')|float(0),'occ': is_state('binary_sensor.grey_occupied_recent','on'),'group':'group.vents_grey_room'},
              {'k':'guest','d': states('sensor.guest_delta_f')|float(0),'occ': is_state('binary_sensor.guest_room_occupied_recent','on'),'group':'group.vents_guest_room'},
              {'k':'family','d': states('sensor.family_delta_f')|float(0),'occ': is_state('binary_sensor.family_room_occupied_recent','on'),'group':'group.vents_family_room'},
              {'k':'kitchen','d': states('sensor.kitchen_delta_f')|float(0),'occ': is_state('binary_sensor.kitchen_occupied_recent','on'),'group':'group.vents_kitchen'},
              {'k':'basement','d': states('sensor.basement_delta_f')|float(0),'occ': is_state('binary_sensor.basement_occupied_recent','on'),'group':'group.vents_basement'}
            ] }}

          # Relief candidates exclude opposite-demand rooms:
          #  - Heat: use rooms with d >= 0 (cold or on-target); ignore hot rooms (d < 0)
          #  - Cool: use rooms with d <= 0 (hot or on-target); ignore cold rooms (d > 0)
          base_cand: "{{ rooms | rejectattr('k','in',selected_list) | list }}"
          cand: >
            {% if mode == 'heat' or action == 'heating' %}
              {{ base_cand | selectattr('d','>=',0) | list }}
            {% elif mode == 'cool' or action == 'cooling' %}
              {{ base_cand | selectattr('d','<=',0) | list }}
            {% else %}
              {{ base_cand }}
            {% endif %}

          # Relief priority (lower score opens earlier)
          #  - HEAT: largest positive delta first (coldest) → temp_rank = -d
          #  - COOL: most negative delta first (hottest)    → temp_rank =  d
          #  - IDLE: closest to target first                → temp_rank = abs(d)
          #  - Unoccupied preferred for relief (occ_rank 0) over occupied (occ_rank 1)
          relief_scored: >
            {%- set lst = [] -%}
            {%- for r in cand -%}
              {%- set occ_rank = 1 if r.occ else 0 %}
              {%- if mode == 'heat' or action == 'heating' -%}
                {%- set temp_rank = -r.d %}
              {%- elif mode == 'cool' or action == 'cooling' -%}
                {%- set temp_rank =  r.d %}
              {%- else -%}
                {%- set temp_rank = abs(r.d) %}
              {%- endif -%}
              {%- set _ = lst.append({'k':r.k,'group':r.group,'score':(occ_rank,temp_rank)}) -%}
            {%- endfor -%}
            {{ lst | sort(attribute='score') }}

      # 1) Set ALL vents to the safe minimum
      - service: cover.set_cover_position
        target: { entity_id: group.vent_groups_all }
        data: { position: "{{ min_other }}" }

      # 2) Open selected rooms fully (100%)
      - repeat:
          for_each: "{{ selected_list }}"
          sequence:
            - variables:
                grp: >
                  {% set item = (rooms | selectattr('k','equalto',repeat.item) | list) %}
                  {{ item[0]['group'] if item|count > 0 else none }}
            - if:
                - condition: template
                  value_template: "{{ grp is not none }}"
              then:
                - service: cover.set_cover_position
                  target: { entity_id: "{{ grp }}" }
                  data: { position: 100 }

      # 3) Enforce ≤ 1/3 closed using temp/occ-aware relief ordering
      - variables:
          all_covers: >
            {{ expand('group.vent_groups_all')
               | map(attribute='entity_id') | map('expand') | sum(start=[])
               | map(attribute='entity_id') | list }}
          closed_count: >
            {{ expand(all_covers)
               | selectattr('attributes.current_position','defined')
               | map(attribute='attributes.current_position')
               | select('le', close_thr) | list | count }}
          total_vents: "{{ expand(all_covers) | list | count }}"
          max_closed: "{{ (total_vents // 3) | int }}"
      - if:
          - condition: template
            value_template: "{{ total_vents > 0 and closed_count > max_closed }}"
        then:
          - repeat:
              for_each: "{{ relief_scored }}"
              sequence:
                - service: cover.set_cover_position
                  target: { entity_id: "{{ repeat.item.group }}" }
                  data: { position: "{{ relief_pct }}" }
                - variables:
                    closed_now: >
                      {{ expand(all_covers)
                         | selectattr('attributes.current_position','defined')
                         | map(attribute='attributes.current_position')
                         | select('le', close_thr) | list | count }}
                - if:
                    - condition: template
                      value_template: "{{ closed_now <= max_closed }}"
                  then:
                    - stop: "⅓-closed limit satisfied (delta/occ-aware relief complete)"

  apply_ecobee_hold_for_rooms:
    alias: "Apply Ecobee hold for multiple rooms (with heat boost; per-room targets)"
    mode: restart
    fields:
      rooms_csv: {}
    sequence:
      - variables:
          do_boost: "{{ is_state('input_boolean.heat_boost_enabled','on') }}"
          boost: "{{ states('input_number.heat_boost_f') | float(0) }}"
          mode: "{{ states('climate.main_floor_thermostat') }}"
          action: "{{ state_attr('climate.main_floor_thermostat','hvac_action') | default('idle') }}"
          sel: "{{ (rooms_csv|default('')|trim) | replace(' ','') | split(',') if rooms_csv not in ['','none',none] else [] }}"

          tgt:
            master: "{{ states('sensor.master_target_f')|float(72) }}"
            blue:   "{{ states('sensor.blue_target_f')  |float(72) }}"
            gold:   "{{ states('sensor.gold_target_f')  |float(72) }}"
            green:  "{{ states('sensor.green_target_f') |float(72) }}"
            grey:   "{{ states('sensor.grey_target_f')  |float(72) }}"
            guest:  "{{ states('sensor.guest_target_f') |float(72) }}"
            family: "{{ states('sensor.family_target_f')|float(72) }}"
            kitchen:"{{ states('sensor.kitchen_target_f')|float(72) }}"
            basement:"{{ states('sensor.basement_target_f')|float(72) }}"

          heat_target: >
            {% set nums = [] %}
            {% for k in sel %}{% set _ = nums.append(tgt[k] | float(72)) %}{% endfor %}
            {{ (nums|max) if nums|count>0 else 72 }}
          cool_target: >
            {% set nums = [] %}
            {% for k in sel %}{% set _ = nums.append(tgt[k] | float(72)) %}{% endfor %}
            {{ (nums|min) if nums|count>0 else 72 }}

      - choose:
          # HEAT: nudge setpoint by boost; never change hvac_mode
          - conditions: "{{ mode == 'heat' or action == 'heating' }}"
            sequence:
              - service: climate.set_temperature
                target: { entity_id: climate.main_floor_thermostat }
                data:
                  temperature: "{{ heat_target + (boost if do_boost else 0) }}"
          # COOL: hold at min selected target; never change hvac_mode
          - conditions: "{{ mode == 'cool' or action == 'cooling' }}"
            sequence:
              - service: climate.set_temperature
                target: { entity_id: climate.main_floor_thermostat }
                data:
                  temperature: "{{ cool_target }}"
          # AUTO/HEAT_COOL: bias low bound upward by boost for heat calls
          - conditions: "{{ mode in ['auto','heat_cool'] }}"
            sequence:
              - variables:
                  lo: "{{ heat_target + (boost if do_boost else 0) }}"
                  hi: "{{ cool_target }}"
              - service: climate.set_temperature
                target: { entity_id: climate.main_floor_thermostat }
                data:
                  target_temp_low: "{{ lo }}"
                  target_temp_high: "{{ hi }}"

# ───────────────────────────
# AUTOMATION – main control loop
# ───────────────────────────
automation:
  - id: zone_conditioner_multiroom
    alias: "Zone Controller – Multi-Room (Per-Room Targets / Delta)"
    mode: queued
    trigger:
      - platform: state
        entity_id:
          - sensor.master_delta_f
          - sensor.blue_delta_f
          - sensor.gold_delta_f
          - sensor.green_delta_f
          - sensor.grey_delta_f
          - sensor.guest_delta_f
          - sensor.family_delta_f
          - sensor.kitchen_delta_f
          - sensor.basement_delta_f
          - binary_sensor.master_occupied_recent
          - binary_sensor.blue_occupied_recent
          - binary_sensor.gold_occupied_recent
          - binary_sensor.green_occupied_recent
          - binary_sensor.grey_occupied_recent
          - binary_sensor.guest_room_occupied_recent
          - binary_sensor.family_room_occupied_recent
          - binary_sensor.kitchen_occupied_recent
          - binary_sensor.basement_occupied_recent
      - platform: state
        entity_id: climate.main_floor_thermostat
      - platform: state
        entity_id: climate.main_floor_thermostat
        attribute: hvac_action
      - platform: time_pattern
        minutes: "/5"
    condition:
      - condition: template
        value_template: "{{ states('climate.main_floor_thermostat') in ['heat','cool','auto','heat_cool'] }}"
    action:
      - variables:
          rooms_csv: "{{ states('sensor.rooms_to_condition') }}"
      - service: script.set_multi_room_vents
        data: { rooms_csv: "{{ rooms_csv }}" }
      - choose:
          - conditions: "{{ rooms_csv not in ['','none'] }}"
            sequence:
              - service: script.apply_ecobee_hold_for_rooms
                data: { rooms_csv: "{{ rooms_csv }}" }
